<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ—¨ï¸ ì»¤í”Œ ì±„íŒ… + AI í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #chatLog, #aiLog {
      border: 1px solid #ccc; padding: 10px; height: 200px;
      overflow-y: scroll; margin-top: 10px; white-space: pre-wrap;
    }
    input, textarea { margin: 5px 0; width: 100%; }
    .my-message { color: blue; }
    .partner-message { color: green; }
  </style>
</head>
<body>
  <h2>ğŸ’¬ ì»¤í”Œ ì±„íŒ…</h2>

  <label>ë‚´ ID:</label>
  <input id="myId" placeholder="ì˜ˆ: userA" onchange="connectSocketIfNeeded()" />

  <label>ìƒëŒ€ë°© ID:</label>
  <input id="peerId" placeholder="ì˜ˆ: userB" onchange="connectSocketIfNeeded()" />

  <label>ì»¤í”Œ ID:</label>
  <input id="coupleId" placeholder="ì˜ˆ: couple123" onchange="connectSocketIfNeeded()" />

  <label>ë©”ì‹œì§€:</label>
  <textarea id="messageInput" rows="3"></textarea>
  <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  <button onclick="loadHistory()">ğŸ“œ ê¸°ë¡ ë³´ê¸°</button>

  <h3>ğŸ“© ì±„íŒ… ë¡œê·¸:</h3>
  <div id="chatLog"></div>

  <hr>

  <h2>ğŸ¤– AI ì±—ë´‡</h2>

  <label>AIì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€:</label>
  <textarea id="aiInput" rows="3"></textarea>
  <button onclick="chatWithAI()">AIì—ê²Œ ì „ì†¡</button>

  <h3>ğŸ§  AI ì‘ë‹µ ë¡œê·¸:</h3>
  <div id="aiLog"></div>

  <hr>

  <h2>ğŸ“› ì±—ë´‡ ì´ë¦„ ì„¤ì •</h2>
  <input id="botNameInput" placeholder="ì˜ˆ: ë¬´ë¯¼" />
  <button onclick="setBotName()">ì±—ë´‡ ì´ë¦„ ì„¤ì •</button>
  <p id="botStatus"></p>

  <script>
    let socket;

    function connectSocketIfNeeded() {
      const myId = document.getElementById("myId").value;
      const peerId = document.getElementById("peerId").value;
      const coupleId = document.getElementById("coupleId").value;

      if (!myId || !peerId || !coupleId) return;

      if (!socket || socket.readyState !== WebSocket.OPEN) {
        socket = new WebSocket(`ws://localhost:8000/ws/${myId}`);

        socket.onopen = () => {
          console.log("ğŸ“¡ WebSocket ì—°ê²°ë¨");
          socket.send(JSON.stringify({
            type: "register_couple",
            partner_id: peerId,
            couple_id: coupleId
          }));
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const myId = document.getElementById("myId").value;
          const log = document.getElementById("chatLog");

          if (data.type === "status") {
            log.innerHTML += `<p><em>ğŸ”” ${data.user}ë‹˜ì´ ${data.status}</em></p>`;
          } else if (data.type === "message") {
            // ğŸ’¬ ë‚´ ë©”ì‹œì§€ëŠ” íŒŒë€ìƒ‰, ìƒëŒ€ ë©”ì‹œì§€ëŠ” ì´ˆë¡ìƒ‰ í‘œì‹œ
            if (data.from === myId) {
              log.innerHTML += `<p><strong class="my-message">${data.from} (ë‚˜)</strong>: ${data.message}</p>`;
            } else {
              log.innerHTML += `<p><strong class="partner-message">${data.from}</strong>: ${data.message}</p>`;
            }
          } else if (data.type === "system") {
            log.innerHTML += `<p><em>ğŸ“¢ ${data.message}</em></p>`;
          } else if (data.type === "error") {
            log.innerHTML += `<p style="color:red"><strong>[ì—ëŸ¬]</strong> ${data.message}</p>`;
          }

          log.scrollTop = log.scrollHeight;
        };

        socket.onclose = () => console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");
      }
    }

    function sendMessage() {
      const myId = document.getElementById("myId").value;
      const coupleId = document.getElementById("coupleId").value;
      const message = document.getElementById("messageInput").value;
      const log = document.getElementById("chatLog");

      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }

      // ğŸ’¬ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë°”ë¡œ ì±„íŒ…ì°½ì— ì¶”ê°€ (ì¹´í†¡ ìŠ¤íƒ€ì¼)
      log.innerHTML += `<p><strong class="my-message">${myId} (ë‚˜)</strong>: ${message}</p>`;
      log.scrollTop = log.scrollHeight;

      socket.send(JSON.stringify({
        type: "message",
        couple_id: coupleId,
        message,
        image_url: null
      }));

      document.getElementById("messageInput").value = "";
    }

    async function loadHistory() {
      const coupleId = document.getElementById("coupleId").value;
      if (!coupleId) {
        alert("ì»¤í”Œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const res = await fetch(`http://localhost:8000/history/${coupleId}`);
      const data = await res.json();
      const log = document.getElementById("chatLog");
      log.innerHTML = "<h4>ğŸ“œ ê¸°ë¡:</h4>";
      data.forEach(msg => {
        log.innerHTML += `<p><strong>${msg.user_id}</strong> (${msg.created_at}): ${msg.content}</p>`;
      });
    }

    async function chatWithAI() {
      const user_id = document.getElementById("myId").value;
      const couple_id = document.getElementById("coupleId").value;
      const message = document.getElementById("aiInput").value;
      const aiLog = document.getElementById("aiLog");

      if (!user_id || !couple_id || !message) {
        alert("user_id, couple_id, ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      aiLog.innerHTML += `ğŸ‘¤ ë‚˜: ${message}\nğŸ¤– AI: `;

      const res = await fetch("http://localhost:8000/chat/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, couple_id, message })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let done = false;

      while (!done) {
        const { value, done: doneReading } = await reader.read();
        done = doneReading;
        if (value) {
          aiLog.innerHTML += decoder.decode(value);
          aiLog.scrollTop = aiLog.scrollHeight;
        }
      }

      aiLog.innerHTML += "\n";
      document.getElementById("aiInput").value = "";
    }

    async function setBotName() {
      const user_id = document.getElementById("myId").value;
      const couple_id = document.getElementById("coupleId").value;
      const persona_name = document.getElementById("botNameInput").value;
      const status = document.getElementById("botStatus");

      if (!couple_id || !persona_name) {
        alert("ì»¤í”Œ IDì™€ ì±—ë´‡ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const res = await fetch("http://localhost:8000/chat/configure", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, persona_name })
      });

      const data = await res.json();
      status.innerText = `âœ… ${data.message}`;
    }
  </script>
</body>
</html>
